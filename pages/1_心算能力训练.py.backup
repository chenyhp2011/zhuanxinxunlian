# pages/1_å¿ƒç®—èƒ½åŠ›è®­ç»ƒ.py

# ==============================================================================
# 1. å¯¼å…¥æ‰€éœ€åº“
# ==============================================================================
# å¯¼å…¥streamlitåº“ï¼Œå®ƒæ˜¯æ„å»ºè¿™ä¸ªWebåº”ç”¨ç•Œé¢çš„æ ¸å¿ƒæ¡†æ¶ï¼Œé€šå¸¸ç®€å†™ä¸ºst
import streamlit as st
# ä»æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„`modules/calculator_logic.py`æ–‡ä»¶ä¸­ï¼Œå¯¼å…¥ç”¨äºç”Ÿæˆæ•°å­¦é¢˜çš„å‡½æ•°
from modules.calculator_logic import generate_math_problem
# å¯¼å…¥Pythonå†…ç½®çš„timeåº“ï¼Œç”¨äºå¤„ç†æ—¶é—´ç›¸å…³çš„æ“ä½œï¼Œå¦‚æ­¤å¤„çš„è®¡æ—¶å™¨åŠŸèƒ½
import time

# ==============================================================================
# 2. é¡µé¢åŸºç¡€é…ç½®
# ==============================================================================
# `st.set_page_config` ç”¨äºè®¾ç½®ç½‘é¡µæ ‡ç­¾ï¼ˆTabï¼‰çš„åŸºæœ¬å±æ€§ã€‚
# è¿™æ¡å‘½ä»¤åº”è¯¥æ˜¯è„šæœ¬ä¸­ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„Streamlitå‘½ä»¤ã€‚
st.set_page_config(
    page_title="å¿ƒç®—èƒ½åŠ›è®­ç»ƒ",  # è®¾ç½®æµè§ˆå™¨æ ‡ç­¾é¡µä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜
    page_icon="ğŸ§®"  # è®¾ç½®æµè§ˆå™¨æ ‡ç­¾é¡µä¸Šæ˜¾ç¤ºçš„å›¾æ ‡
)

# `st.title` ç”¨äºåœ¨åº”ç”¨çš„ä¸»é¡µé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªå¤§æ ‡é¢˜
st.title("ğŸ§® å¿ƒç®—èƒ½åŠ›è®­ç»ƒ")

# ==============================================================================
# 3. ä¼šè¯çŠ¶æ€ (Session State) åˆå§‹åŒ–
# ==============================================================================
# Streamlitåº”ç”¨çš„è„šæœ¬åœ¨æ¯æ¬¡ç”¨æˆ·äº¤äº’åéƒ½ä¼šä»å¤´åˆ°å°¾é‡æ–°è¿è¡Œã€‚
# `st.session_state` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—å…¸å¼å¯¹è±¡ï¼Œç”¨äºåœ¨å¤šæ¬¡è¿è¡Œä¹‹é—´ä¿å­˜æ•°æ®ã€‚
# ä¸‹é¢çš„ä»£ç å—æ£€æŸ¥æŸä¸ªå…³é”®å˜é‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ„å‘³ç€æ˜¯ç”¨æˆ·é¦–æ¬¡åŠ è½½é¡µé¢ï¼Œ
# æ­¤æ—¶éœ€è¦åˆå§‹åŒ–æ‰€æœ‰æˆ‘ä»¬å°†ç”¨åˆ°çš„çŠ¶æ€å˜é‡ã€‚

if 'calc_level' not in st.session_state:
    # `calc_level` ç”¨äºæ§åˆ¶å½“å‰çš„æ¸¸æˆçŠ¶æ€ï¼š
    # 0  : åˆå§‹çŠ¶æ€ï¼Œæ˜¾ç¤ºéš¾åº¦é€‰æ‹©ç•Œé¢
    # >0 : æ¸¸æˆè¿›è¡Œä¸­ï¼Œå€¼ä¸º1-6ï¼Œä»£è¡¨ä¸åŒéš¾åº¦
    # -1 : æ¸¸æˆç»“æŸï¼Œæ˜¾ç¤ºæ€»ç»“ç•Œé¢
    st.session_state.calc_level = 0

    # `calc_score` ç”¨äºè®°å½•ç©å®¶çš„å¾—åˆ†
    st.session_state.calc_score = 0

    # `calc_questions_answered` ç”¨äºè®°å½•å·²ç»å›ç­”äº†å¤šå°‘é“é¢˜
    st.session_state.calc_questions_answered = 0

    # `current_problem` ç”¨äºå­˜å‚¨å½“å‰æ˜¾ç¤ºçš„é¢˜ç›®å­—ç¬¦ä¸²
    st.session_state.current_problem = ""

    # `current_answer` ç”¨äºå­˜å‚¨å½“å‰é¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
    st.session_state.current_answer = None

    # `last_feedback` ç”¨äºå­˜å‚¨ä¸Šä¸€é¢˜çš„åé¦ˆä¿¡æ¯ï¼ˆæ­£ç¡®æˆ–é”™è¯¯æç¤ºï¼‰
    st.session_state.last_feedback = ""

    # `start_time` ç”¨äºè®°å½•å½“å‰é¢˜ç›®å¼€å§‹çš„æ—¶é—´æˆ³ï¼Œä»¥ä¾¿è®¡ç®—å‰©ä½™æ—¶é—´
    st.session_state.start_time = 0

# ==============================================================================
# 4. ç•Œé¢æ¸²æŸ“é€»è¾‘åˆ†å‘
# æ ¹æ® `calc_level` çš„å€¼ï¼Œå†³å®šæ˜¾ç¤ºå“ªä¸ªç•Œé¢
# ==============================================================================

# ------------------------------------------------------------------------------
# 4.1. æ˜¾ç¤ºéš¾åº¦é€‰æ‹©ç•Œé¢
# ------------------------------------------------------------------------------
# å¦‚æœ `calc_level` ä¸º 0ï¼Œè¯´æ˜æ¸¸æˆè¿˜æœªå¼€å§‹ï¼Œæ˜¾ç¤ºéš¾åº¦é€‰æ‹©æŒ‰é’®ã€‚
if st.session_state.calc_level == 0:
    # `st.info` åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªè“è‰²çš„ä¿¡æ¯æ¡†ï¼Œç”¨äºæä¾›è¯´æ˜ã€‚
    st.info("è¯·é€‰æ‹©ä¸€ä¸ªéš¾åº¦ç­‰çº§å¼€å§‹è®­ç»ƒã€‚æ¯é“é¢˜éƒ½æœ‰æ—¶é—´é™åˆ¶ï¼")

    # `st.columns(3)` åˆ›å»ºä¸€ä¸ªåŒ…å«3ä¸ªåˆ—çš„ç½‘æ ¼å¸ƒå±€ï¼Œè®©æŒ‰é’®æ’åˆ—æ›´ç¾è§‚ã€‚
    cols = st.columns(3)
    # `levels` åˆ—è¡¨å­˜å‚¨äº†6ä¸ªéš¾åº¦æŒ‰é’®ä¸Šè¦æ˜¾ç¤ºçš„æ–‡æœ¬ã€‚
    levels = ["ç­‰çº§1 (5ç§’)", "ç­‰çº§2 (10ç§’)", "ç­‰çº§3 (15ç§’)", "ç­‰çº§4 (20ç§’)", "ç­‰çº§5 (25ç§’)", "ç­‰çº§6 (30ç§’)"]

    # `enumerate` å‡½æ•°å¯ä»¥åŒæ—¶éå†åˆ—è¡¨çš„ç´¢å¼• `i` å’Œå…ƒç´  `level_desc`ã€‚
    for i, level_desc in enumerate(levels):
        # `i % 3` çš„ç»“æœä¼šåœ¨ 0, 1, 2 ä¹‹é—´å¾ªç¯ï¼Œè¿™æ ·æŒ‰é’®å°±ä¼šä¾æ¬¡æ”¾å…¥3ä¸ªåˆ—ä¸­ã€‚
        # `st.button` åˆ›å»ºä¸€ä¸ªæŒ‰é’®ã€‚å½“ç”¨æˆ·ç‚¹å‡»è¿™ä¸ªæŒ‰é’®æ—¶ï¼Œè¿™ä¸ªifæ¡ä»¶åˆ¤æ–­ä¸ºTrueã€‚
        # `key` æ˜¯æ¯ä¸ªUIç»„ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯¹äºå¾ªç¯ä¸­åˆ›å»ºçš„ç»„ä»¶ï¼Œè®¾ç½®å”¯ä¸€çš„keyè‡³å…³é‡è¦ã€‚
        if cols[i % 3].button(level_desc, key=f"level_{i + 1}"):
            # --- ä»¥ä¸‹æ˜¯ç”¨æˆ·ç‚¹å‡»éš¾åº¦æŒ‰é’®åæ‰§è¡Œçš„é€»è¾‘ ---
            # 1. è®¾ç½®æ¸¸æˆç­‰çº§
            st.session_state.calc_level = i + 1
            # 2. é‡ç½®æ¸¸æˆæ•°æ®
            st.session_state.calc_score = 0
            st.session_state.calc_questions_answered = 0
            st.session_state.last_feedback = ""
            # 3. ç”Ÿæˆç¬¬ä¸€é“é¢˜
            problem, answer = generate_math_problem(st.session_state.calc_level)
            st.session_state.current_problem = problem
            st.session_state.current_answer = answer
            # 4. è®°å½•æ¸¸æˆå¼€å§‹æ—¶é—´
            st.session_state.start_time = time.time()
            # 5. `st.rerun()` å¼ºåˆ¶é¡µé¢ç«‹å³é‡æ–°åŠ è½½ã€‚æ­¤æ—¶`calc_level`å·²ä¸å†ä¸º0ï¼Œé¡µé¢å°†æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢ã€‚
            st.rerun()

# ------------------------------------------------------------------------------
# 4.2. æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢
# ------------------------------------------------------------------------------
# å¦‚æœ `calc_level` ä¸ä¸º 0ï¼Œåˆ™è¿›å…¥æ­¤åˆ†æ”¯ï¼Œæ˜¾ç¤ºæ¸¸æˆç›¸å…³å†…å®¹ã€‚
else:
    # æ ¹æ®å½“å‰ç­‰çº§è®¡ç®—æ¯é“é¢˜çš„æ—¶é—´é™åˆ¶
    time_limit = st.session_state.calc_level * 5

    # `st.subheader` åˆ›å»ºä¸€ä¸ªäºŒçº§æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰ç­‰çº§ã€‚
    st.subheader(f"ç­‰çº§ {st.session_state.calc_level}")
    # åˆ›å»ºä¸¤åˆ—æ¥åˆ†åˆ«æ˜¾ç¤ºå¾—åˆ†å’Œè¿›åº¦ã€‚
    score_col, progress_col = st.columns(2)
    # `st.metric` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºå±•ç¤ºå…³é”®æŒ‡æ ‡çš„ç»„ä»¶ï¼Œæœ‰æ ‡é¢˜ã€æ•°å€¼å’Œå¯é€‰çš„å¢å‡é‡ã€‚
    score_col.metric("å¾—åˆ†", st.session_state.calc_score)
    progress_col.metric("è¿›åº¦", f"{st.session_state.calc_questions_answered} / 20")

    # `st.markdown("---")` åœ¨é¡µé¢ä¸Šæ¸²æŸ“ä¸€æ¡æ°´å¹³åˆ†å‰²çº¿ã€‚
    st.markdown("---")

    # `st.header` åˆ›å»ºä¸€ä¸ªä¸‰çº§æ ‡é¢˜ï¼Œç”¨äºæ˜¾ç¤ºé¢˜ç›®ã€‚
    # æ–‡æœ¬ä¸¤ä¾§çš„åå¼•å· `` ä¼šè®©Streamlitä½¿ç”¨ç­‰å®½å­—ä½“æ¸²æŸ“ï¼Œé€‚åˆæ˜¾ç¤ºä»£ç æˆ–ç®—å¼ã€‚
    st.header(f"`{st.session_state.current_problem} = ?`")


    # --- å®šä¹‰æ ¸å¿ƒé€»è¾‘å‡½æ•° ---

    # `handle_answer` å‡½æ•°è´Ÿè´£å¤„ç†ç­”æ¡ˆçš„åˆ¤æ–­ã€åˆ†æ•°çš„æ›´æ–°ä»¥åŠæ–°é¢˜ç›®çš„ç”Ÿæˆã€‚
    def handle_answer(is_correct, reason=""):
        # å¦‚æœç­”æ¡ˆæ­£ç¡®...
        if is_correct:
            st.session_state.calc_score += 10  # åˆ†æ•°åŠ 10
            st.session_state.last_feedback = "æ­£ç¡®ï¼ğŸ‰"  # è®¾ç½®æ­£ç¡®çš„åé¦ˆä¿¡æ¯
        # å¦‚æœç­”æ¡ˆé”™è¯¯...
        else:
            correct_answer = st.session_state.current_answer
            st.session_state.last_feedback = f"{reason} æ­£ç¡®ç­”æ¡ˆæ˜¯: {correct_answer} ğŸ’ª"

        # ä¸è®ºå¯¹é”™ï¼Œå·²å›ç­”é¢˜ç›®æ•°éƒ½åŠ 1
        st.session_state.calc_questions_answered += 1
        # å¦‚æœ20é¢˜è¿˜æ²¡ç­”å®Œ...
        if st.session_state.calc_questions_answered < 20:
            # ç”Ÿæˆæ–°é¢˜ç›®
            problem, answer = generate_math_problem(st.session_state.calc_level)
            st.session_state.current_problem = problem
            st.session_state.current_answer = answer
            st.session_state.start_time = time.time()  # ä¸ºæ–°é¢˜ç›®é‡ç½®è®¡æ—¶å™¨
        # å¦‚æœ20é¢˜å·²å…¨éƒ¨ç­”å®Œ...
        else:
            # è®¾ç½®æ¸¸æˆçŠ¶æ€ä¸º-1ï¼Œè¡¨ç¤ºæ¸¸æˆç»“æŸ
            st.session_state.calc_level = -1


    # `handle_submit` å‡½æ•°ä½œä¸ºè¾“å…¥æ¡†çš„å›è°ƒï¼Œåœ¨ç”¨æˆ·æäº¤ç­”æ¡ˆæ—¶è¢«è§¦å‘ã€‚
    def handle_submit():
        try:
            # `st.session_state.user_input` ä¼šè‡ªåŠ¨è·å–è¾“å…¥æ¡†ä¸­çš„å€¼
            user_answer = int(st.session_state.user_input)
            # è°ƒç”¨ `handle_answer` å‡½æ•°è¿›è¡Œåˆ¤æ–­
            handle_answer(user_answer == st.session_state.current_answer, "å›ç­”é”™è¯¯ï¼")
        except (ValueError, TypeError):
            # å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹æ— æ³•è½¬æ¢ä¸ºæ•´æ•°ï¼ˆä¾‹å¦‚è¾“å…¥äº†å­—æ¯ï¼‰ï¼Œåˆ™åˆ¤ä¸ºæ— æ•ˆè¾“å…¥
            handle_answer(False, "è¾“å…¥æ— æ•ˆï¼")

        # æäº¤åæ¸…ç©ºè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·è¾“å…¥ä¸‹ä¸€é¢˜ç­”æ¡ˆ
        st.session_state.user_input = ""


    # --- åˆ›å»ºUIç»„ä»¶ ---

    # `st.empty()` åˆ›å»ºä¸€ä¸ªç©ºçš„å®¹å™¨ï¼ˆå ä½ç¬¦ï¼‰ï¼Œåç»­å¯ä»¥ç”¨ä»£ç å‘å…¶ä¸­åŠ¨æ€å¡«å…¥å†…å®¹ã€‚
    feedback_placeholder = st.empty()
    # å¦‚æœ `last_feedback` ä¸ä¸ºç©ºï¼ˆå³éç¬¬ä¸€é¢˜ï¼‰ï¼Œåˆ™æ˜¾ç¤ºåé¦ˆä¿¡æ¯ã€‚
    if st.session_state.last_feedback:
        # æ ¹æ®åé¦ˆå†…å®¹æ˜¯åŒ…å«â€œæ­£ç¡®â€è¿˜æ˜¯â€œé”™è¯¯â€ï¼Œæ¥æ˜¾ç¤ºä¸åŒé¢œè‰²çš„æç¤ºæ¡†ã€‚
        if "æ­£ç¡®" in st.session_state.last_feedback:
            feedback_placeholder.success(st.session_state.last_feedback)  # ç»¿è‰²æˆåŠŸæ¡†
        else:
            feedback_placeholder.error(st.session_state.last_feedback)  # çº¢è‰²é”™è¯¯æ¡†

    # `st.text_input` åˆ›å»ºä¸€ä¸ªæ–‡æœ¬è¾“å…¥æ¡†ã€‚
    # `on_change=handle_submit` æ˜¯ä¸€ä¸ªå›è°ƒè®¾ç½®ï¼Œè¡¨ç¤ºå½“è¾“å…¥æ¡†å†…å®¹æ”¹å˜ä¸”ç”¨æˆ·æŒ‰ä¸‹å›è½¦æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨`handle_submit`å‡½æ•°ã€‚
    # `disabled` å‚æ•°ç”¨äºæ§åˆ¶ç»„ä»¶æ˜¯å¦å¯äº¤äº’ã€‚å½“æ¸¸æˆç»“æŸæ—¶(`calc_level`ä¸º-1)ï¼Œç¦ç”¨è¾“å…¥æ¡†ã€‚
    st.text_input("è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ:", key="user_input", on_change=handle_submit,
                  disabled=(st.session_state.calc_level == -1))

    # --- è®¡æ—¶å™¨ä¸è‡ªåŠ¨åˆ·æ–°é€»è¾‘ ---

    # åªæœ‰åœ¨æ¸¸æˆè¿›è¡Œä¸­ (`calc_level` > 0) æ‰æ‰§è¡Œè®¡æ—¶å’Œåˆ·æ–°é€»è¾‘ã€‚
    if st.session_state.calc_level > 0:
        # è®¡ç®—å·²è¿‡æ—¶é—´å’Œå‰©ä½™æ—¶é—´
        time_elapsed = time.time() - st.session_state.start_time
        time_left = time_limit - time_elapsed

        # åˆ›å»ºä¸€ä¸ªå ä½ç¬¦ç”¨äºæ˜¾ç¤ºè¿›åº¦æ¡
        timer_placeholder = st.empty()
        # `st.progress` åˆ›å»ºä¸€ä¸ªè¿›åº¦æ¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯0åˆ°1ä¹‹é—´çš„å°æ•°ï¼Œè¡¨ç¤ºè¿›åº¦ç™¾åˆ†æ¯”ã€‚
        timer_placeholder.progress(max(0, time_left) / time_limit, text=f"å‰©ä½™æ—¶é—´: {max(0, int(time_left))} ç§’")

        # å¦‚æœæ—¶é—´ç”¨å®Œ...
        if time_left < 0:
            handle_answer(False, "è¶…æ—¶ï¼")  # è°ƒç”¨å¤„ç†å‡½æ•°ï¼Œåˆ¤ä¸ºè¶…æ—¶é”™è¯¯
            st.rerun()  # ç«‹å³åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºä¸‹ä¸€é¢˜

        # è¿™æ˜¯ä¸€ä¸ªå®ç°â€œå®æ—¶â€åŠ¨ç”»æ•ˆæœçš„æŠ€å·§
        time.sleep(0.1)  # è®©ç¨‹åºæš‚åœ0.1ç§’ï¼Œä»¥é™ä½CPUå ç”¨ç‡
        st.rerun()  # å¼ºåˆ¶é¡µé¢åˆ·æ–°ï¼Œä»è€Œä¸æ–­æ›´æ–°è¿›åº¦æ¡å’Œå‰©ä½™æ—¶é—´æ˜¾ç¤º

    # ------------------------------------------------------------------------------
    # 4.3. æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
    # ------------------------------------------------------------------------------
    # å½“æ¸¸æˆçŠ¶æ€ä¸º-1æ—¶ï¼Œæ‰§è¡Œæ­¤ä»£ç å—ã€‚
    elif st.session_state.calc_level == -1:
        # `st.balloons()` åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªåº†ç¥çš„å½©å¸¦åŠ¨ç”»ã€‚
        st.balloons()
        # æ˜¾ç¤ºæœ€ç»ˆå¾—åˆ†ã€‚
        st.success(f"è®­ç»ƒå®Œæˆï¼ä½ çš„æœ€ç»ˆå¾—åˆ†æ˜¯: {st.session_state.calc_score}")
        # æä¾›ä¸€ä¸ªæŒ‰é’®è®©ç”¨æˆ·è¿”å›éš¾åº¦é€‰æ‹©ç•Œé¢ã€‚
        if st.button("è¿”å›éš¾åº¦é€‰æ‹©"):
            st.session_state.calc_level = 0  # å°†çŠ¶æ€é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
            st.rerun()  # åˆ·æ–°é¡µé¢ï¼Œæ­¤æ—¶å°†æ˜¾ç¤ºéš¾åº¦é€‰æ‹©ç•Œé¢