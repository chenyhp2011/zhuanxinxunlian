# pages/1_å¿ƒç®—èƒ½åŠ›è®­ç»ƒ.py
# import streamlit as st; st.error("è¿™æ˜¯ä¸€ä¸ªå¼ºåˆ¶æµ‹è¯•ä¿¡æ¯ï¼Œå¦‚æœçœ‹åˆ°å®ƒï¼Œè¯´æ˜æ‚¨æ­£åœ¨è¿è¡Œæœ€æ–°çš„æ–‡ä»¶ã€‚")
# ==============================================================================
# 1. å¯¼å…¥æ‰€éœ€åº“
# ==============================================================================
import streamlit as st
from modules.calculator_logic import generate_math_problem
import time

# ==============================================================================
# 2. é¡µé¢åŸºç¡€é…ç½®
# ==============================================================================
st.set_page_config(
    page_title="å¿ƒç®—èƒ½åŠ›è®­ç»ƒ",
    page_icon="ğŸ§®"
)
st.title("ğŸ§® å¿ƒç®—èƒ½åŠ›è®­ç»ƒ")

# ==============================================================================
# 3. ä¼šè¯çŠ¶æ€ (Session State) åˆå§‹åŒ–
# ==============================================================================
if 'calc_level' not in st.session_state:
    st.session_state.calc_level = 0  # 0: å¾…é€‰æ‹©, >0: æ¸¸æˆä¸­, -1: æ¸¸æˆç»“æŸ
    st.session_state.calc_score = 0
    st.session_state.calc_questions_answered = 0
    st.session_state.current_problem = ""
    st.session_state.current_answer = None
    st.session_state.last_feedback = ""
    st.session_state.start_time = 0


# ==============================================================================
# 4. ç•Œé¢æ¸²æŸ“å‡½æ•° (ä½¿ç”¨å‡½æ•°å°è£…å®ç°UIéš”ç¦»)
# ==============================================================================

def select_level(level_choice):
    """
    è¿™æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç”¨æˆ·ç‚¹å‡»éš¾åº¦æŒ‰é’®æ—¶è¢«è§¦å‘ã€‚
    å®ƒè´Ÿè´£å®‰å…¨åœ°æ›´æ–°æ‰€æœ‰ç›¸å…³çš„ä¼šè¯çŠ¶æ€ï¼Œä¸ºæ¸¸æˆåšå‡†å¤‡ã€‚
    """
    st.session_state.calc_level = level_choice
    st.session_state.calc_score = 0
    st.session_state.calc_questions_answered = 0
    st.session_state.last_feedback = ""
    if level_choice > 0:  # åªæœ‰åœ¨é€‰æ‹©æ–°æ¸¸æˆæ—¶æ‰ç”Ÿæˆé¢˜ç›®
        problem, answer = generate_math_problem(st.session_state.calc_level)
        st.session_state.current_problem = problem
        st.session_state.current_answer = answer
        st.session_state.start_time = time.time()


def show_difficulty_selection():
    """ä¸“é—¨è´Ÿè´£æ˜¾ç¤ºéš¾åº¦é€‰æ‹©ç•Œé¢çš„å‡½æ•°"""
    st.info("è¯·é€‰æ‹©ä¸€ä¸ªéš¾åº¦ç­‰çº§å¼€å§‹è®­ç»ƒã€‚æ¯é“é¢˜éƒ½æœ‰æ—¶é—´é™åˆ¶ï¼")

    cols = st.columns(3)
    levels = ["ç­‰çº§1 (5ç§’)", "ç­‰çº§2 (10ç§’)", "ç­‰çº§3 (15ç§’)", "ç­‰çº§4 (20ç§’)", "ç­‰çº§5 (25ç§’)", "ç­‰çº§6 (30ç§’)"]

    for i, level_desc in enumerate(levels):
        # æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ on_click å‚æ•°ç»‘å®šå›è°ƒå‡½æ•°ï¼Œè¿™æ˜¯æœ€ç¨³å¥çš„æ–¹å¼
        cols[i % 3].button(
            level_desc,
            key=f"level_{i + 1}",
            on_click=select_level,
            args=(i + 1,)  # å°†è¦è®¾ç½®çš„ç­‰çº§ (i+1) ä½œä¸ºå‚æ•°ä¼ ç»™å›è°ƒå‡½æ•°
        )


def show_game_interface():
    """ä¸“é—¨è´Ÿè´£æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢çš„å‡½æ•°"""
    st.info(f"å½“å‰çš„æ¸¸æˆç­‰çº§(calc_level)æ˜¯: {st.session_state.calc_level}")

    time_limit = st.session_state.calc_level * 5

    st.subheader(f"ç­‰çº§ {st.session_state.calc_level}")
    score_col, progress_col = st.columns(2)
    score_col.metric("å¾—åˆ†", st.session_state.calc_score)
    progress_col.metric("è¿›åº¦", f"{st.session_state.calc_questions_answered} / 20")

    st.markdown("---")
    st.header(f"`{st.session_state.current_problem} = ?`")

    def handle_answer(is_correct, reason=""):
        if is_correct:
            st.session_state.calc_score += 10
            st.session_state.last_feedback = "æ­£ç¡®ï¼ğŸ‰"
        else:
            correct_answer = st.session_state.current_answer
            st.session_state.last_feedback = f"{reason} æ­£ç¡®ç­”æ¡ˆæ˜¯: {correct_answer} ğŸ’ª"

        st.session_state.calc_questions_answered += 1
        if st.session_state.calc_questions_answered < 20:
            problem, answer = generate_math_problem(st.session_state.calc_level)
            st.session_state.current_problem = problem
            st.session_state.current_answer = answer
            st.session_state.start_time = time.time()
        else:
            st.session_state.calc_level = -1

    def handle_submit():
        try:
            user_answer = int(st.session_state.user_input)
            handle_answer(user_answer == st.session_state.current_answer, "å›ç­”é”™è¯¯ï¼")
        except (ValueError, TypeError):
            if st.session_state.user_input != "": handle_answer(False, "è¾“å…¥æ— æ•ˆï¼")
        st.session_state.user_input = ""

    feedback_placeholder = st.empty()
    if st.session_state.last_feedback:
        if "æ­£ç¡®" in st.session_state.last_feedback:
            feedback_placeholder.success(st.session_state.last_feedback)
        else:
            feedback_placeholder.error(st.session_state.last_feedback)

    st.text_input("è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ:", key="user_input", on_change=handle_submit)

    time_elapsed = time.time() - st.session_state.start_time
    time_left = time_limit - time_elapsed

    timer_placeholder = st.empty()
    timer_placeholder.progress(max(0, time_left) / time_limit, text=f"å‰©ä½™æ—¶é—´: {max(0, int(time_left))} ç§’")

    if time_left < 0:
        handle_answer(False, "è¶…æ—¶ï¼")
        st.rerun()

    time.sleep(0.1)
    st.rerun()


def show_game_over_screen():
    """ä¸“é—¨è´Ÿè´£æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢çš„å‡½æ•°"""
    st.balloons()
    st.success(f"è®­ç»ƒå®Œæˆï¼ä½ çš„æœ€ç»ˆå¾—åˆ†æ˜¯: {st.session_state.calc_score}")
    # ä½¿ç”¨ on_click é‡ç½®çŠ¶æ€ï¼Œè¿”å›ä¸»èœå•
    st.button("è¿”å›éš¾åº¦é€‰æ‹©", on_click=select_level, args=(0,))


# ==============================================================================
# 5. ä¸»é€»è¾‘åˆ†å‘å™¨
# ==============================================================================
# è¿™ä¸ª if/elif/else ç»“æ„ç¡®ä¿äº†åœ¨ä»»ä½•æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªç•Œé¢å‡½æ•°ä¼šè¢«æ‰§è¡Œ
if st.session_state.calc_level == 0:
    show_difficulty_selection()
elif st.session_state.calc_level == -1:
    show_game_over_screen()
else:  # calc_level is > 0
    show_game_interface()